# MPI_Syrk_implentation

## Overview

Implementation of the BLAS level 3 algorithm SYRK (Symmetric -k Rank update) using MPI Reduce Scatter.

## Prerequisite

The following software is needed to run this Project:

1. CMake (^3.18)
2. OpenMPI (^4.1.4) 
3. OpenBlas (^0.3.26)

Test requirements:

1. GTest

## Getting Started

Download the repository with:

```
git clone HeldJohannes/MPI_Syrk_implementation
```

The test files are to big for normal git, for this reason the repository uses git LFS.
To receive the files `git pull` should automatically pull the files if it isn't the case run:

```
git lfs pull
```

To build the config files 

```
cmake -S . -B build
```

The `CMakeList.txt` contain the following options, which can be set by `-D<OPTION>=<VALUE>`

| Options       | Description |
|---------------|-------------|
| `HYDRA`       | Working on the test server (default OFF) |
|Â `PACKAGE_TESTS` | Compil the tests (default ON)Â |
|Â |Â |

build the code
```
cmake --build build
```

## ðŸ“– Usage

```
mpirun -np <CORES> MPI_SYRK_implementation -m <ROWS> -n <COLS> -a <ALGORITHM> [-c <PRIME_NUMBER>] [input_file]
```

### ðŸ”§ **Parameters & Options**  

| Option               | Description |
|----------------------|-------------|
| `-m <ROWS>`         | **(Required)** Number of rows in the input matrix |
| `-n <COLS>`         | **(Required)** Number of columns in the input matrix |
| `-a <ALGORITHM>`    | **(Required)** Algorithm mode (`0`, `1`, `2`, or `3`) |
| `-c <CONFIG>`       | **(Optional, only if `-a 3`)** Configuration parameter for algorithm `3` which fullfills = c(c + 1) for prime c |
| `<input_file>`      | **(Optional)** Input file; if not provided, a random input will be generated |

### âš™ **Examples**  

input and expected result:

```
       
        1,  2                      1,  4
        3,  4                      2,  5
        5,  6                      3,  6
       ------                    ------
1,3,5| 35, 44              1,2,3| 14, 32
2,4,6| 44, 56              4,5,6| 32, 77
```

1. **Run with random input (no input file specified)**  
```bash
mpirun -np 4 MPI_SYRK_implementation -m 100 -n 50 -a 1
```

2. **Run with a specified input file**  
```bash
mpirun -np 4 MPI_SYRK_implementation -m 100 -n 50 -a 2 input.txt
```

3. **Algorithm `3` with additional `-c` option**  
```bash
mpirun -np 4 MPI_SYRK_implementation -m 200 -n 100 -a 3 -c config.txt input.txt
```

---

### ðŸ“‚ **Test Files & Expected Results**  

**Test files** and **expected results** can be found in:  
  - Input files: `./resource/input/`  
  - Expected results: `./resource/in/`  
  - Expected test outputs: `./resource/output/`  

The first number in the test files represents the **number of rows** (= m), and the second number represents the **number of columns** (= n).  


### Verifying Results

You can use the R script `./resource/Check.R` to check if the computation is correct

```
Rscript --vanilla ./resource/Check.R <result_file> <input_file> [TRUE|FALSE]
```

| Parameter       | Description |
|---------------|-------------|
| `<result_file>` | The output file generated by `MPI_SYRK_implementation`. |
| `<input_file>`  | The input file used by `MPI_SYRK_implementation` to compute the result. |
| `[TRUE\|FALSE]` (Optional) | If set to `TRUE`, the script will ignore the lower half of the result matrix during verification. Defaults to `FALSE` if not provided. |

### Example

```
mpirun -np 1 ./build/src/MPI_SYRK_implementation -m 60 -n 40 -a 0 ./resource/input/test60x40.csv;
Rscript --vanilla ./resource/Check.R ./syrk_result.csv ./resource/input/test60x40.csv FALSE
```

## Generate Testdata

You can use the R script in the test folder to generate testdata:

```
Rscript --vanilla ./resourec/GernateTestdata.R <dir_to_safe> <Number of Rows (m)> <Number of Cols (n)>
```

## Helpful Links

- [Open MPI](https://www.jetbrains.com/help/clion/openmpi.html)
- [Pkg-Config](https://people.freedesktop.org/~dbn/pkg-config-guide.html)
- [C Make FindBLAS](https://cmake.org/cmake/help/v3.18/module/FindBLAS.html)
- [C Make find_package()](https://cmake.org/cmake/help/v3.18/command/find_package.html#search-modes)
- [Slurm tutorial](https://www.uibk.ac.at/zid/systeme/hpc-systeme/common/tutorials/slurm-tutorial.html#HDR2_1_1)


## Helpful commads

### Load OpenMpi

<details>
    <summary>Under Mac OS</summary>

    - ### Using `brew`
        - Install

          to install OpenMPI with brew  you can use the following command
          `brew install open-mpi`
</details>

<details>
    <summary>on HYDRA</summary>

    The module mpi has to be loaded every day with:
    ```
    module load mpi/openmpiS
    ```
    The loaded modeles can be checked with:
    ```
    module list
    ```
    To get the current directory path:
    ```
    pwd
    ```
    To add the `blas.pc`to the pkg-config path use the following command in the directory where the file is:
    ```
    export PKG_CONFIG_PATH=$(pwd)
    ```
    to check that the command worked use:
    ```
    echo $PKG_CONFIG_PATH
    ```
    to check that the pkg-config is found by the pkg-config command use:
    ```
    pkg-config --modversion blas
    ```

</details>


### to build the system

<details>
    <summary>on HYDRA</summary>

    ```
    mkdir build
    cd build/
    cmake .. -DHYDRA=ON
    cmake --build .
    ```
</details>


### To test that everything works as expected:

```
mpiexec -np 1 ./build/src/MPI_SYRK_implementation -m 2 -n 3 -a 2 ./resource/input/test2x3.csv
```